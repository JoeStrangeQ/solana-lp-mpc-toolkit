# MnM DLMM Leverage Protocol - Architecture

**Version:** 2.0  
**Updated:** February 2026

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MnM DLMM LEVERAGE PROTOCOL                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   FRONTEND  â”‚â”€â”€â”€â”€â–¶â”‚  SERVICES   â”‚â”€â”€â”€â”€â–¶â”‚  PROGRAMS   â”‚â”€â”€â”€â”€â–¶â”‚  EXTERNAL â”‚ â”‚
â”‚  â”‚   (React)   â”‚     â”‚    (TS)     â”‚     â”‚  (Solana)   â”‚     â”‚   (CPI)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                   â”‚                   â”‚                   â”‚        â”‚
â”‚        â–¼                   â–¼                   â–¼                   â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Components  â”‚     â”‚dlmmService  â”‚     â”‚ mnm-lending â”‚     â”‚  Meteora  â”‚ â”‚
â”‚  â”‚ - Leverage  â”‚     â”‚collateral   â”‚     â”‚ - deposit   â”‚     â”‚   DLMM    â”‚ â”‚
â”‚  â”‚ - Position  â”‚     â”‚leverage     â”‚     â”‚ - borrow    â”‚     â”‚           â”‚ â”‚
â”‚  â”‚ - Health    â”‚     â”‚lending      â”‚     â”‚ - liquidate â”‚     â”‚   Pyth    â”‚ â”‚
â”‚  â”‚ - Pool      â”‚     â”‚             â”‚     â”‚ - flash     â”‚     â”‚  Oracle   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer Architecture

### Layer 1: Frontend (React + Vite)

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ DLMMLeverageInterface.tsx    # Main leverage UI
â”‚   â”œâ”€â”€ PositionManager.tsx          # Manage open positions
â”‚   â”œâ”€â”€ PoolSelector.tsx             # Select DLMM pool
â”‚   â”œâ”€â”€ LeverageSlider.tsx           # Leverage amount control
â”‚   â””â”€â”€ HealthFactorDisplay.tsx      # Risk visualization
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useDLMMPosition.ts           # Position state management
â”‚   â”œâ”€â”€ useHealthFactor.ts           # Real-time risk monitoring
â”‚   â””â”€â”€ useLeverageCalculator.ts     # Leverage math helpers
â”‚
â””â”€â”€ providers/
    â”œâ”€â”€ WalletProvider.tsx           # Solana wallet connection
    â””â”€â”€ ConvexProvider.tsx           # State persistence
```

### Layer 2: Services (TypeScript)

```
src/services/
â”œâ”€â”€ dlmmService.ts          # Meteora DLMM SDK wrapper
â”‚   â”œâ”€â”€ getPoolInfo()       # Fetch pool data
â”‚   â”œâ”€â”€ createPosition()    # Create DLMM position
â”‚   â”œâ”€â”€ addLiquidity()      # Add to existing position
â”‚   â””â”€â”€ removeLiquidity()   # Remove from position
â”‚
â”œâ”€â”€ collateralService.ts    # LP token collateral management
â”‚   â”œâ”€â”€ depositCollateral() # Lock LP as collateral
â”‚   â”œâ”€â”€ withdrawCollateral()# Unlock LP tokens
â”‚   â”œâ”€â”€ calculateValue()    # LP valuation via oracle
â”‚   â””â”€â”€ getUserPositions()  # Fetch user's collateral
â”‚
â”œâ”€â”€ leverageService.ts      # Atomic leverage operations
â”‚   â”œâ”€â”€ buildLeverageTransaction()   # Create leveraged position
â”‚   â”œâ”€â”€ buildDeleverageTransaction() # Close/reduce position
â”‚   â”œâ”€â”€ increaseLeverage()           # Add more leverage
â”‚   â””â”€â”€ decreaseLeverage()           # Reduce leverage
â”‚
â””â”€â”€ lendingService.ts       # Pool operations
    â”œâ”€â”€ deposit()           # Deposit to lending pool
    â”œâ”€â”€ withdraw()          # Withdraw from pool
    â””â”€â”€ getPoolStats()      # TVL, APY, utilization
```

### Layer 3: Utilities

```
src/utils/
â”œâ”€â”€ riskCalculations.ts     # Risk management math
â”‚   â”œâ”€â”€ calculateHealthFactor()
â”‚   â”œâ”€â”€ calculateLTV()
â”‚   â”œâ”€â”€ calculatePositionRisk()
â”‚   â”œâ”€â”€ calculateLiquidation()
â”‚   â”œâ”€â”€ validateBorrow()
â”‚   â””â”€â”€ validateWithdrawal()
â”‚
â”œâ”€â”€ dlmmMath.ts             # DLMM-specific calculations
â”‚   â”œâ”€â”€ calculateBinAmounts()
â”‚   â”œâ”€â”€ estimateImpermanentLoss()
â”‚   â””â”€â”€ calculateFeeAPY()
â”‚
â””â”€â”€ lpValuation.ts          # LP token pricing
    â”œâ”€â”€ getLPTokenPrice()
    â””â”€â”€ getUnderlyingAmounts()
```

### Layer 4: Solana Programs (Anchor)

```
programs/mnm-lending/src/
â”œâ”€â”€ lib.rs                  # Program entry
â”‚
â”œâ”€â”€ instructions/
â”‚   â”œâ”€â”€ initialize_pool.rs  # Create lending pool
â”‚   â”œâ”€â”€ deposit.rs          # Deposit to pool
â”‚   â”œâ”€â”€ withdraw.rs         # Withdraw from pool
â”‚   â”œâ”€â”€ deposit_collateral.rs    # Lock LP as collateral
â”‚   â”œâ”€â”€ withdraw_collateral.rs   # Unlock LP tokens
â”‚   â”œâ”€â”€ borrow.rs           # Borrow against collateral
â”‚   â”œâ”€â”€ repay.rs            # Repay borrowed tokens
â”‚   â”œâ”€â”€ flash_borrow.rs     # Flash loan borrow
â”‚   â”œâ”€â”€ flash_repay.rs      # Flash loan repay
â”‚   â”œâ”€â”€ liquidate.rs        # Liquidate position
â”‚   â””â”€â”€ atomic_leverage.rs  # Atomic loop instruction
â”‚
â””â”€â”€ state/
    â”œâ”€â”€ pool.rs             # Lending pool account
    â”œâ”€â”€ loan.rs             # Active loan account
    â”œâ”€â”€ position.rs         # Collateral position
    â””â”€â”€ flash_receipt.rs    # Flash loan tracking
```

---

## Data Flow Diagrams

### 1. Create Leveraged Position Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CREATE LEVERAGED POSITION FLOW                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  USER                     FRONTEND                    SOLANA                 â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚ 1. Select pool, amount   â”‚                          â”‚                    â”‚
â”‚   â”‚    leverage (2x-5x)      â”‚                          â”‚                    â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                          â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚                    2. Validate params               â”‚                    â”‚
â”‚   â”‚                    3. Fetch pool info               â”‚                    â”‚
â”‚   â”‚                    4. Calculate amounts             â”‚                    â”‚
â”‚   â”‚                    5. Estimate health factor        â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                          â”‚                    â”‚
â”‚   â”‚   Show preview           â”‚                          â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚ 6. Confirm transaction   â”‚                          â”‚                    â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                          â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚                    7. Build atomic tx:              â”‚                    â”‚
â”‚   â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                    â”‚
â”‚   â”‚                       â”‚ Instruction 1:       â”‚      â”‚                    â”‚
â”‚   â”‚                       â”‚   flash_borrow()     â”‚      â”‚                    â”‚
â”‚   â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚                    â”‚
â”‚   â”‚                       â”‚ Instruction 2:       â”‚      â”‚                    â”‚
â”‚   â”‚                       â”‚   create_position()  â”‚â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–¶ Meteora DLMM  â”‚
â”‚   â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚                    â”‚
â”‚   â”‚                       â”‚ Instruction 3:       â”‚      â”‚                    â”‚
â”‚   â”‚                       â”‚   deposit_collateral â”‚â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–¶ MnM Lending   â”‚
â”‚   â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚                    â”‚
â”‚   â”‚                       â”‚ Instruction 4:       â”‚      â”‚                    â”‚
â”‚   â”‚                       â”‚   borrow()           â”‚â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–¶ MnM Lending   â”‚
â”‚   â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚                    â”‚
â”‚   â”‚                       â”‚ Instruction 5:       â”‚      â”‚                    â”‚
â”‚   â”‚                       â”‚   flash_repay()      â”‚      â”‚                    â”‚
â”‚   â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚ 8. Sign transaction      â”‚                          â”‚                    â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                          â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚                    9. Send to Solana â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–¶ Execute       â”‚
â”‚   â”‚                          â”‚                          â”‚      atomically    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚                          â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 10. Confirmation   â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â”‚   â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                          â”‚                    â”‚
â”‚   â”‚  Position created!       â”‚                          â”‚                    â”‚
â”‚   â”‚  Show new health factor  â”‚                          â”‚                    â”‚
â”‚   â”‚                          â”‚                          â”‚                    â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Health Factor Monitoring Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HEALTH FACTOR MONITORING FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   TIMER (every 30s)              SERVICE                  UI                 â”‚
â”‚        â”‚                           â”‚                       â”‚                 â”‚
â”‚        â”‚ 1. Trigger check          â”‚                       â”‚                 â”‚
â”‚        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                       â”‚                 â”‚
â”‚        â”‚                           â”‚                       â”‚                 â”‚
â”‚        â”‚                     2. Fetch user positions       â”‚                 â”‚
â”‚        â”‚                           â”‚                       â”‚                 â”‚
â”‚        â”‚                     3. For each position:         â”‚                 â”‚
â”‚        â”‚                        â”‚                          â”‚                 â”‚
â”‚        â”‚                        â”œâ”€â–¶ Get LP value (Oracle)  â”‚                 â”‚
â”‚        â”‚                        â”œâ”€â–¶ Get debt balance       â”‚                 â”‚
â”‚        â”‚                        â””â”€â–¶ Calculate health       â”‚                 â”‚
â”‚        â”‚                           â”‚                       â”‚                 â”‚
â”‚        â”‚                     4. Classify:                  â”‚                 â”‚
â”‚        â”‚                        â”‚                          â”‚                 â”‚
â”‚        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                 â”‚
â”‚        â”‚          â–¼             â–¼             â–¼            â”‚                 â”‚
â”‚        â”‚      HF > 1.2      1.1 < HF < 1.2   HF < 1.1      â”‚                 â”‚
â”‚        â”‚      (Healthy)     (Warning)       (Danger)       â”‚                 â”‚
â”‚        â”‚          â”‚             â”‚             â”‚            â”‚                 â”‚
â”‚        â”‚          â”‚             â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Show alert      â”‚
â”‚        â”‚          â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Show warning    â”‚
â”‚        â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Update display  â”‚
â”‚        â”‚                           â”‚                       â”‚                 â”‚
â”‚        â”‚                     5. If HF < 1.0:               â”‚                 â”‚
â”‚        â”‚                        Liquidation possible       â”‚                 â”‚
â”‚        â”‚                        Show critical alert        â”‚                 â”‚
â”‚        â”‚                           â”‚                       â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Liquidation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LIQUIDATION FLOW                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  LIQUIDATOR                  PROGRAM                      POSITION OWNER    â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚                          â”‚  Position becomes unhealthy  â”‚             â”‚
â”‚      â”‚                          â”‚  (HF < 1.0 due to price drop)â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚ 1. Monitor positions     â”‚                              â”‚             â”‚
â”‚      â”‚    (off-chain bot)       â”‚                              â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚ 2. Find liquidatable     â”‚                              â”‚             â”‚
â”‚      â”‚    position (HF < 1.0)   â”‚                              â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚ 3. Call liquidate()      â”‚                              â”‚             â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                              â”‚             â”‚
â”‚      â”‚    (repay $50 debt)      â”‚                              â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚                    4. Verify HF < 1.0                   â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚                    5. Calculate amounts:                â”‚             â”‚
â”‚      â”‚                       debt_repaid = $50                 â”‚             â”‚
â”‚      â”‚                       bonus = 5% = $2.50                â”‚             â”‚
â”‚      â”‚                       collateral_seized = $52.50        â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚                    6. Transfer:                         â”‚             â”‚
â”‚      â”‚                       $50 USDC: Liquidator â†’ Pool       â”‚             â”‚
â”‚      â”‚                       $52.50 LP: Position â†’ Liquidator  â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚                    7. Update position:                  â”‚             â”‚
â”‚      â”‚                       debt: $100 â†’ $50                  â”‚             â”‚
â”‚      â”‚                       collateral: $100 â†’ $47.50         â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚                              â”‚             â”‚
â”‚      â”‚  Profit: $2.50           â”‚                              â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â”‚      â”‚                          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚             â”‚
â”‚      â”‚                          â”‚  Emit LiquidationEvent       â”‚             â”‚
â”‚      â”‚                          â”‚  (owner can see on explorer) â”‚             â”‚
â”‚      â”‚                          â”‚                              â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Machine: Position Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     POSITION STATE MACHINE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                           â”‚    START     â”‚                                   â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                        â”‚   INITIALIZING  â”‚                                   â”‚
â”‚                        â”‚ (tx in progress)â”‚                                   â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                 â”‚                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚              â”‚ Success          â”‚                  â”‚ Failure                 â”‚
â”‚              â–¼                  â”‚                  â–¼                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚     â”‚     ACTIVE     â”‚          â”‚         â”‚   CANCELLED   â”‚                  â”‚
â”‚     â”‚  (HF > 1.2)    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚             â”‚                                                                â”‚
â”‚             â”‚ Price moves / Interest accrues                                 â”‚
â”‚             â”‚                                                                â”‚
â”‚             â–¼                                                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚     â”‚   MONITORING   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ (continuous)   â”‚                             â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚                         â”‚
â”‚             â”‚                                      â”‚                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                         â”‚
â”‚    â”‚        â”‚        â”‚            â”‚               â”‚                         â”‚
â”‚    â–¼        â–¼        â–¼            â–¼               â”‚                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                         â”‚
â”‚ â”‚HEALTHYâ”‚ â”‚ WARN â”‚ â”‚DANGERâ”‚ â”‚LIQUIDATABLEâ”‚         â”‚                         â”‚
â”‚ â”‚HF>1.2 â”‚ â”‚1.1-  â”‚ â”‚1.0-  â”‚ â”‚ HF < 1.0  â”‚         â”‚                         â”‚
â”‚ â”‚  ğŸŸ¢   â”‚ â”‚ 1.2  â”‚ â”‚ 1.1  â”‚ â”‚    ğŸ”´     â”‚         â”‚                         â”‚
â”‚ â”‚       â”‚ â”‚ ğŸŸ¡   â”‚ â”‚ ğŸŸ    â”‚ â”‚           â”‚         â”‚                         â”‚
â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚                         â”‚
â”‚     â”‚        â”‚        â”‚           â”‚               â”‚                         â”‚
â”‚     â”‚        â”‚        â”‚           â–¼               â”‚                         â”‚
â”‚     â”‚        â”‚        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                         â”‚
â”‚     â”‚        â”‚        â”‚    â”‚ LIQUIDATED â”‚         â”‚                         â”‚
â”‚     â”‚        â”‚        â”‚    â”‚ (partial)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚     â”‚        â”‚        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚     â”‚        â”‚        â”‚                                                      â”‚
â”‚     â”‚ User repays / adds collateral                                         â”‚
â”‚     â”‚        â”‚        â”‚                                                      â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                                                    â”‚                         â”‚
â”‚                                                    â–¼                         â”‚
â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                                           â”‚    CLOSED     â”‚                  â”‚
â”‚                                           â”‚ (user repaid) â”‚                  â”‚
â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Account Structure (Solana PDAs)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SOLANA ACCOUNT STRUCTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  LENDING POOL (PDA)                                                         â”‚
â”‚  Seeds: ["pool", token_mint]                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ authority: Pubkey       # Pool authority                           â”‚    â”‚
â”‚  â”‚ token_mint: Pubkey      # USDC mint                                â”‚    â”‚
â”‚  â”‚ token_vault: Pubkey     # Pool token account                       â”‚    â”‚
â”‚  â”‚ total_deposits: u64     # Total deposited                          â”‚    â”‚
â”‚  â”‚ total_borrows: u64      # Total borrowed                           â”‚    â”‚
â”‚  â”‚ interest_rate: u64      # Current interest rate (bps)              â”‚    â”‚
â”‚  â”‚ last_update: i64        # Last interest accrual                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  COLLATERAL POSITION (PDA)                                                  â”‚
â”‚  Seeds: ["position", owner, dlmm_position]                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ owner: Pubkey           # Position owner                           â”‚    â”‚
â”‚  â”‚ dlmm_pool: Pubkey       # Meteora DLMM pool                        â”‚    â”‚
â”‚  â”‚ dlmm_position: Pubkey   # Meteora position address                 â”‚    â”‚
â”‚  â”‚ deposited_at: i64       # Deposit timestamp                        â”‚    â”‚
â”‚  â”‚ initial_value_usd: u64  # Value at deposit (cached)                â”‚    â”‚
â”‚  â”‚ token_x_amount: u64     # SOL amount in position                   â”‚    â”‚
â”‚  â”‚ token_y_amount: u64     # USDC amount in position                  â”‚    â”‚
â”‚  â”‚ is_active: bool         # Position status                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  LOAN (PDA)                                                                 â”‚
â”‚  Seeds: ["loan", owner, collateral_position]                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ owner: Pubkey           # Borrower                                 â”‚    â”‚
â”‚  â”‚ collateral_position: Pubkey  # Linked collateral                   â”‚    â”‚
â”‚  â”‚ borrowed_amount: u64    # Principal borrowed                       â”‚    â”‚
â”‚  â”‚ accrued_interest: u64   # Interest accumulated                     â”‚    â”‚
â”‚  â”‚ borrowed_at: i64        # Loan creation time                       â”‚    â”‚
â”‚  â”‚ last_accrual: i64       # Last interest update                     â”‚    â”‚
â”‚  â”‚ interest_rate: u64      # Rate at borrow time                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  FLASH RECEIPT (PDA)                                                        â”‚
â”‚  Seeds: ["flash", borrower, slot_number]                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ borrower: Pubkey        # Flash loan recipient                     â”‚    â”‚
â”‚  â”‚ amount: u64             # Borrowed amount                          â”‚    â”‚
â”‚  â”‚ token_mint: Pubkey      # Token borrowed                           â”‚    â”‚
â”‚  â”‚ slot: u64               # Slot when borrowed                       â”‚    â”‚
â”‚  â”‚ fee: u64                # Fee to repay                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## External Integrations

### Meteora DLMM Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      METEORA DLMM INTEGRATION                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  dlmmService.ts                           Meteora SDK                        â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 1. Import SDK                          â”‚                             â”‚
â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                             â”‚
â”‚       â”‚    @meteora-ag/dlmm                    â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 2. Fetch pool                          â”‚                             â”‚
â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                             â”‚
â”‚       â”‚    DLMM.create(connection, poolPK)     â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                             â”‚
â”‚       â”‚    Pool state (bins, liquidity, etc)   â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 3. Create position                     â”‚                             â”‚
â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                             â”‚
â”‚       â”‚    dlmm.initializePositionAndAddLiq()  â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                             â”‚
â”‚       â”‚    Position address + LP tokens        â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 4. Remove liquidity                    â”‚                             â”‚
â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                             â”‚
â”‚       â”‚    dlmm.removeLiquidity()              â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pyth Oracle Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PYTH ORACLE INTEGRATION                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  MnM Program                              Pyth Network                       â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 1. Read price feed account             â”‚                             â”‚
â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                             â”‚
â”‚       â”‚    SOL/USD: H6ARHf6YXhGYeQfUzQNGk...   â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 2. Validate:                           â”‚                             â”‚
â”‚       â”‚    - Is price fresh? (< 60 seconds)    â”‚                             â”‚
â”‚       â”‚    - Is price positive?                â”‚                             â”‚
â”‚       â”‚    - Is confidence interval OK?        â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚       â”‚ 3. Use price for:                      â”‚                             â”‚
â”‚       â”‚    - Collateral valuation              â”‚                             â”‚
â”‚       â”‚    - Health factor calculation         â”‚                             â”‚
â”‚       â”‚    - Liquidation eligibility           â”‚                             â”‚
â”‚       â”‚                                        â”‚                             â”‚
â”‚  Price Feeds:                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ SOL/USD:  H6ARHf6YXhGYeQfUzQNGk6whP2UFknLFMoJEKgjmMqN        â”‚           â”‚
â”‚  â”‚ USDC/USD: Gnt27xtC473ZT2Mw5u8wZ68Z3gULkSTb5DuxJy7eJotD       â”‚           â”‚
â”‚  â”‚ USDT/USD: 3vxLXJqLqF3JG5TCbYycbKWRBbCJQLxQmBGCkyqEEefL       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ERROR CODES                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  PROGRAM ERRORS                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  InsufficientFunds (6000)     User doesn't have enough tokens               â”‚
â”‚  ExceedsMaxLTV (6001)         Borrow would exceed 80% LTV                   â”‚
â”‚  PositionNotLiquidatable (6002)   Health factor > 1.0                       â”‚
â”‚  InvalidPriceFeed (6003)      Oracle account not recognized                 â”‚
â”‚  StalePriceFeed (6004)        Price older than 60 seconds                   â”‚
â”‚  FlashLoanNotRepaid (6005)    Flash loan same-tx repayment failed           â”‚
â”‚  PositionNotActive (6006)     Collateral position already closed            â”‚
â”‚  InsufficientCollateral (6007) Not enough collateral for operation          â”‚
â”‚  SlippageExceeded (6008)      Trade slippage above tolerance                â”‚
â”‚                                                                              â”‚
â”‚  SERVICE ERRORS                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  POOL_NOT_FOUND               DLMM pool doesn't exist                       â”‚
â”‚  INVALID_LEVERAGE             Leverage < 1.1x or > 5x                       â”‚
â”‚  MIN_AMOUNT_NOT_MET           Below $10 minimum                             â”‚
â”‚  TRANSACTION_TOO_LARGE        Exceeded Solana tx size limit                 â”‚
â”‚  SIMULATION_FAILED            Tx simulation showed failure                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SECURITY MODEL                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. ATOMICITY                                                                â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     All leverage operations are atomic:                                      â”‚
â”‚     - 5 instructions in single transaction                                   â”‚
â”‚     - Any failure reverts entire operation                                   â”‚
â”‚     - No partial state possible                                              â”‚
â”‚                                                                              â”‚
â”‚  2. ORACLE SAFETY                                                            â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     - Price staleness check (60 second max)                                  â”‚
â”‚     - Confidence interval validation                                         â”‚
â”‚     - Multi-oracle fallback planned                                          â”‚
â”‚                                                                              â”‚
â”‚  3. ACCESS CONTROL                                                           â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     - Position owner: withdraw, repay, close                                 â”‚
â”‚     - Any liquidator: liquidate (if HF < 1.0)                               â”‚
â”‚     - Pool authority: emergency pause                                        â”‚
â”‚                                                                              â”‚
â”‚  4. ECONOMIC SAFETY                                                          â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     - 80% max LTV (buffer before liquidation)                               â”‚
â”‚     - 85% liquidation threshold                                              â”‚
â”‚     - 5% liquidation penalty (incentivizes liquidators)                      â”‚
â”‚     - 50% max liquidation per tx (prevents total wipeout)                   â”‚
â”‚                                                                              â”‚
â”‚  5. FLASH LOAN PROTECTION                                                    â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     - Receipt PDA keyed by slot (non-reusable)                              â”‚
â”‚     - Must repay in same transaction                                        â”‚
â”‚     - 0.09% fee covers protocol costs                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment

### Devnet

```bash
# Deploy program
anchor deploy --provider.cluster devnet

# Initialize pool
npx ts-node scripts/deploy.ts init-pool --token USDC

# Addresses
Program ID: MnM5Q7h3MrF9k8dJvP2nW6xY4aB1cD3eF5gH7iJ9kL0
USDC Pool: 4xY7aB1cD3eF5gH7iJ9kL0mN2oP3qR5sT7uV8wX1yZ2
```

### Mainnet (Planned)

```bash
# Requires:
# 1. Security audit completion
# 2. Bug bounty program live
# 3. Gradual liquidity cap rollout
```

---

_For usage examples, see [DLMM_LEVERAGE.md](./DLMM_LEVERAGE.md)_
